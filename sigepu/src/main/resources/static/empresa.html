<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Portal Empresarial - SIGEPU</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f4f4f9; color: #333; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px 30px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .profile-header { display: flex; align-items: center; gap: 15px; }
        .avatar-container { position: relative; width: 60px; height: 60px; }
        .avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .avatar-upload { position: absolute; bottom: 0; right: 0; background: #007bff; color: white; width: 20px; height: 20px; border-radius: 50%; text-align: center; line-height: 20px; font-size: 12px; cursor: pointer; }
        .hidden-input { display: none; }
        .btn-logout { background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }

        .container { display: flex; gap: 20px; }
        .left-column { flex: 6; display: flex; flex-direction: column; gap: 20px; }
        .right-column { flex: 4; }
        .panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        input, textarea, select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: inherit; }
        label { font-weight: bold; font-size: 0.9em; margin-bottom: 5px; display: block; }
        .btn-save { background: #007bff; color: white; width: 100%; padding: 10px; border: none; cursor: pointer; font-weight: bold; border-radius: 4px; }

        .card { background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #dee2e6; position: relative; }
        .card-offer { border-left: 5px solid #6610f2; }
        .card-offer.inactive { border-left: 5px solid #6c757d; opacity: 0.7; background: #eaeaea; }
        .card-candidate { border-left: 5px solid #28a745; background-color: #fff; cursor: pointer; }
        
        .btn-sm { padding: 4px 8px; font-size: 0.85em; border-radius: 3px; border: none; cursor: pointer; color: white; margin-left: 5px; }
        .btn-edit { background: #ffc107; color: #333; }
        .btn-toggle-on { background: #28a745; }
        .btn-toggle-off { background: #6c757d; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 400px; position: relative; }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #aaa; }
        .action-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .btn-hire { flex: 1; background: #28a745; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; }
        .btn-discard { flex: 1; background: #dc3545; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="header">
        <div class="profile-header">
            <div class="avatar-container">
                <img src="https://via.placeholder.com/60" id="imgPerfil" class="avatar" alt="Perfil">
                <label for="fileInput" class="avatar-upload">üì∑</label>
                <input type="file" id="fileInput" class="hidden-input" accept="image/*" onchange="subirFoto()">
            </div>
            <div>
                <h2 id="welcomeMsg" style="margin:0;">Cargando...</h2>
                <small style="color:#666; cursor:pointer; text-decoration:underline" onclick="abrirEditarPerfil()">‚úèÔ∏è Editar mis datos</small>
            </div>
        </div>
        <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
    </div>

    <div class="container">
        <div class="left-column">
            <div class="panel">
                <h3 id="formTitle" style="margin-top:0">‚ûï Publicar Nueva Pasant√≠a</h3>
                <input type="hidden" id="editId">
                <label>T√≠tulo:</label> <input type="text" id="titulo" placeholder="Ej: Programador Jr">
                <label>Descripci√≥n:</label> <textarea id="desc" rows="3" placeholder="Requisitos..."></textarea>
                <label>Carrera:</label>
                <select id="carrera">
                    <option value="1">Ingenier√≠a en Sistemas</option>
                    <option value="2">Ingenier√≠a Industrial</option>
                    <option value="3">Admin. de Empresas</option>
                    <option value="4">Mercadeo</option>
                    <option value="5">Dise√±o Gr√°fico</option>
                    <option value="7">Ciencias Jur√≠dicas</option>
                    <option value="9">Psicolog√≠a</option>
                </select>
                <div style="display:flex; gap:10px">
                    <button class="btn-save" id="btnSave" onclick="guardarOferta()">Publicar Oferta</button>
                    <button class="btn-save" id="btnCancelEdit" onclick="cancelarEdicion()" style="background:#6c757d; display:none;">Cancelar</button>
                </div>
            </div>
            <div class="panel">
                <h3 style="margin-top:0">üì¶ Mis Ofertas Activas</h3>
                <div id="ofertasList">Cargando...</div>
            </div>
        </div>
        <div class="right-column">
            <div class="panel">
                <h3 style="margin-top:0">üë• Candidatos Aprobados</h3>
                <p style="font-size:0.9em; color:#666">Validados por la UTEC.</p>
                <div id="candidatosList">Cargando...</div>
            </div>
        </div>
    </div>

    <div id="modalPerfil" class="modal-overlay">
        <div class="modal-content">
            <h3>Editar Datos</h3>
            <label>Nombre Comercial:</label> <input type="text" id="edit_nombre">
            <label>Nueva Contrase√±a:</label> <input type="password" id="edit_pass" placeholder="Dejar vac√≠a para no cambiar">
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button onclick="guardarCambiosPerfil()" class="btn-save" style="background:#28a745; flex:1;">Guardar</button>
                <button onclick="document.getElementById('modalPerfil').style.display='none'" class="btn-save" style="background:#dc3545; flex:1;">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modalEstudiante" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="cerrarModal()">&times;</span>
            <h2 style="margin-top:0; color:#007bff">Candidato</h2>
            <p><strong>Nombre:</strong> <span id="m_nombre"></span></p>
            <p><strong>Carrera:</strong> <span id="m_carrera"></span></p>
            <p><strong>Puesto:</strong> <span id="m_puesto"></span></p>
            <div class="action-buttons">
                <button class="btn-hire" onclick="decidirCandidato('CONTRATAR')">‚úÖ CONTRATAR</button>
                <button class="btn-discard" onclick="decidirCandidato('DESCARTAR')">‚ùå DESCARTAR</button>
            </div>
        </div>
    </div>

    <script>
        let ID_EMPRESA = null, ID_USUARIO = null, APP_SELECCIONADA = null;

        async function iniciar() {
            const sesion = localStorage.getItem('usuario_sigepu');
            if (!sesion) { window.location.href = 'login.html'; return; }
            const usuario = JSON.parse(sesion);
            if (usuario.rol !== 'GESTOR_EMPRESARIAL') { alert("Acceso denegado"); window.location.href = 'login.html'; return; }
            ID_USUARIO = usuario.id;
            try {
                const res = await fetch(`/api/empresas/usuario/${usuario.id}`);
                if (res.ok) {
                    const empresa = await res.json();
                    ID_EMPRESA = empresa.id;
                    document.getElementById('welcomeMsg').innerText = `Empresa: ${empresa.nombre}`;
                    cargarFotoPerfil(); cargarMisOfertas(); cargarCandidatos();
                } else alert("Error empresa");
            } catch(e) {}
        }
        iniciar();

        // Perfil
        async function cargarFotoPerfil() {
            try { const res = await fetch(`/api/perfil/${ID_USUARIO}/foto`); if(res.ok) document.getElementById('imgPerfil').src = (await res.json()).url; } catch(e){}
        }
        async function subirFoto() {
            const file = document.getElementById('fileInput').files[0]; if(!file) return;
            const formData = new FormData(); formData.append("file", file);
            try { const res = await fetch(`/api/perfil/${ID_USUARIO}/foto`, {method:'POST', body:formData}); if(res.ok) document.getElementById('imgPerfil').src = (await res.json()).url; } catch(e){}
        }
        function abrirEditarPerfil() { document.getElementById('modalPerfil').style.display = 'flex'; }
        async function guardarCambiosPerfil() {
            const datos = { nombre: document.getElementById('edit_nombre').value, password: document.getElementById('edit_pass').value };
            if(!datos.nombre) delete datos.nombre;
            try { const res = await fetch(`/api/perfil/${ID_USUARIO}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(datos)}); if(res.ok){alert("Actualizado"); location.reload();} } catch(e){}
        }

        // Ofertas
        async function cargarMisOfertas() {
            try {
                const res = await fetch(`/api/pasantias/empresa/${ID_EMPRESA}`);
                const ofertas = await res.json();
                let html = '';
                ofertas.forEach(p => {
                    const active = p.activa, cl = active?'':'inactive', txt=active?'Activa':'Inactiva', btnCl=active?'btn-toggle-off':'btn-toggle-on', btnTx=active?'Desactivar':'Activar';
                    html += `<div class="card card-offer ${cl}"><div style="display:flex; justify-content:space-between"><h4>${p.titulo} <small>(${txt})</small></h4><div><button class="btn-sm btn-edit" onclick='cargarEdit(${JSON.stringify(p)})'>‚úèÔ∏è</button><button class="btn-sm ${btnCl}" onclick="toggle(${p.id})">${btnTx}</button></div></div><p>${p.descripcion}</p><small>${p.carreraRequerida.nombre}</small></div>`;
                });
                document.getElementById('ofertasList').innerHTML = html || "<p>Sin ofertas.</p>";
            } catch(e){}
        }
        async function guardarOferta() {
            const id = document.getElementById('editId').value;
            const datos = { titulo: document.getElementById('titulo').value, descripcion: document.getElementById('desc').value, idEmpresa: ID_EMPRESA, idCarreraRequerida: document.getElementById('carrera').value };
            let url = '/api/pasantias', m = 'POST'; if(id){ url+=`/${id}`; m='PUT'; }
            try { const res = await fetch(url, {method:m, headers:{'Content-Type':'application/json'}, body:JSON.stringify(datos)}); if(res.ok){ alert("Guardado"); cancelarEdicion(); cargarMisOfertas(); } } catch(e){}
        }
        function cargarEdit(p) {
            document.getElementById('formTitle').innerText = "‚úèÔ∏è Editando"; document.getElementById('editId').value = p.id;
            document.getElementById('titulo').value = p.titulo; document.getElementById('desc').value = p.descripcion; document.getElementById('carrera').value = p.carreraRequerida.id;
            document.getElementById('btnSave').innerText = "Guardar"; document.getElementById('btnCancelEdit').style.display = 'inline-block';
        }
        function cancelarEdicion() {
            document.getElementById('formTitle').innerText = "‚ûï Nueva Oferta"; document.getElementById('editId').value = "";
            document.getElementById('titulo').value = ""; document.getElementById('desc').value = "";
            document.getElementById('btnSave').innerText = "Publicar"; document.getElementById('btnCancelEdit').style.display = 'none';
        }
        async function toggle(id) { await fetch(`/api/pasantias/${id}/toggle`, {method:'PUT'}); cargarMisOfertas(); }

        // Candidatos
        async function cargarCandidatos() {
            try {
                const res = await fetch(`/api/aplicaciones/empresa/${ID_EMPRESA}/aprobados`);
                const apps = (await res.json()).filter(a => a.estadoUniversidad === 'APROBADO');
                let html = '';
                apps.forEach(a => html += `<div class="card card-candidate" onclick="abrirModal('${a.estudiante.nombre} ${a.estudiante.apellido}', '${a.estudiante.carrera.nombre}', '${a.pasantia.titulo}', ${a.id})"><h4>üë§ ${a.estudiante.nombre}</h4><small>${a.pasantia.titulo}</small></div>`);
                document.getElementById('candidatosList').innerHTML = html || "<p>Sin candidatos.</p>";
            } catch(e){}
        }
        function abrirModal(n, c, p, id) {
            document.getElementById('m_nombre').innerText = n; document.getElementById('m_carrera').innerText = c; document.getElementById('m_puesto').innerText = p;
            APP_SELECCIONADA = id; document.getElementById('modalEstudiante').style.display = 'flex';
        }
        function cerrarModal() { document.getElementById('modalEstudiante').style.display = 'none'; }
        async function decidirCandidato(acc) {
            if(!confirm("¬øConfirmar?")) return;
            try { const res = await fetch(`/api/aplicaciones/${APP_SELECCIONADA}/estado?accion=${acc}`, {method:'PUT'}); if(res.ok){ alert("Hecho"); cerrarModal(); cargarCandidatos(); } } catch(e){}
        }
        function logout() { localStorage.removeItem('usuario_sigepu'); window.location.href = 'login.html'; }
    </script>
</body>
</html>