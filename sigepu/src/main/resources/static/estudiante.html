<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Portal Estudiante - SIGEPU</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f4f4f9; color: #333; }
        
        /* Encabezado y Perfil */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px 30px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .profile-header { display: flex; align-items: center; gap: 15px; }
        .avatar-container { position: relative; width: 60px; height: 60px; }
        .avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .avatar-upload { position: absolute; bottom: 0; right: 0; background: #007bff; color: white; width: 20px; height: 20px; border-radius: 50%; text-align: center; line-height: 20px; font-size: 12px; cursor: pointer; }
        .hidden-input { display: none; }
        .btn-logout { background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }

        /* Barra de Filtros */
        .filter-bar { background: white; padding: 15px; margin-bottom: 20px; border-radius: 8px; display: flex; align-items: center; gap: 10px; }
        select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; flex-grow: 1; max-width: 300px; }

        /* Formulario Perfil Inicial */
        #profileForm { background: white; padding: 30px; max-width: 500px; margin: 0 auto; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-save { background: #007bff; color: white; width: 100%; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        input { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        label { font-weight: bold; display: block; margin-bottom: 5px; }

        /* Tarjetas de Pasant√≠a */
        .card { background: white; border: 1px solid #e0e0e0; padding: 20px; margin-bottom: 15px; border-radius: 8px; border-left: 5px solid #6c757d; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .card h3 { margin-top: 0; color: #333; }
        
        .btn-apply { background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-apply:hover { background: #218838; }
        .btn-cancel-req { background: #ffc107; color: #333; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em; margin-top: 5px; }

        /* Estados */
        .status-container { padding: 10px; background-color: #f8f9fa; border-radius: 6px; margin-top: 10px; border: 1px solid #eee; }
        .status-label { font-weight: bold; font-size: 0.9em; display: block; margin-bottom: 5px; }
        .st-pendiente { color: #d39e00; border-left: 4px solid #ffc107; padding-left: 8px; }
        .st-aprobado { color: #17a2b8; border-left: 4px solid #17a2b8; padding-left: 8px; }
        .st-rechazado { color: #dc3545; border-left: 4px solid #dc3545; padding-left: 8px; }
        .st-contratado { color: #28a745; border-left: 4px solid #28a745; padding-left: 8px; font-size: 1.1em; }
        .st-no-seleccionado { color: #6c757d; border-left: 4px solid #6c757d; padding-left: 8px; }
        .st-cancelado { color: #343a40; border-left: 4px solid #343a40; padding-left: 8px; text-decoration: line-through; }

        /* Modal Edici√≥n */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 300px; }

        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="header">
        <div class="profile-header">
            <div class="avatar-container">
                <img src="https://via.placeholder.com/60" id="imgPerfil" class="avatar" alt="Perfil">
                <label for="fileInput" class="avatar-upload">üì∑</label>
                <input type="file" id="fileInput" class="hidden-input" accept="image/*" onchange="subirFoto()">
            </div>
            <div>
                <h2 id="welcomeMsg" style="margin:0;">Cargando...</h2>
                <small id="userCareer" style="color:#666; cursor:pointer; text-decoration:underline" onclick="abrirEditarPerfil()">‚úèÔ∏è Editar mis datos</small>
            </div>
        </div>
        <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
    </div>

    <div id="profileSection" class="hidden">
        <div id="profileForm">
            <h2 style="text-align:center">üöÄ ¬°Completa tu Perfil!</h2>
            <p>Para ver las pasant√≠as, necesitamos saber qui√©n eres.</p>
            <label>Nombre:</label> <input type="text" id="p_nombre" placeholder="Ej: Juan">
            <label>Apellido:</label> <input type="text" id="p_apellido" placeholder="Ej: Perez">
            <label>Carrera:</label>
            <select id="p_carrera" style="width:100%; padding:10px; margin-bottom:15px;">
                <option value="1">Ingenier√≠a en Sistemas y Computaci√≥n</option>
                <option value="2">Ingenier√≠a Industrial</option>
                <option value="3">Licenciatura en Administraci√≥n de Empresas</option>
                <option value="4">Licenciatura en Mercadeo</option>
                <option value="5">Licenciatura en Dise√±o Gr√°fico</option>
                <option value="6">Licenciatura en Idioma Ingl√©s</option>
                <option value="7">Licenciatura en Ciencias Jur√≠dicas</option>
                <option value="8">Licenciatura en Contadur√≠a P√∫blica</option>
                <option value="9">Licenciatura en Psicolog√≠a</option>
                <option value="10">Arquitectura</option>
            </select>
            <button class="btn-save" onclick="guardarPerfil()">Guardar y Continuar</button>
        </div>
    </div>

    <div id="mainSection" class="hidden">
        <div class="filter-bar">
            <strong>üîç Filtrar por Carrera:</strong>
            <select id="filtroCarrera" onchange="cargarPasantias()">
                <option value="TODAS">-- Mostrar Todas --</option>
                <option value="Ingenier√≠a en Sistemas y Computaci√≥n">Ingenier√≠a en Sistemas</option>
                <option value="Ingenier√≠a Industrial">Ingenier√≠a Industrial</option>
                <option value="Licenciatura en Administraci√≥n de Empresas">Administraci√≥n de Empresas</option>
                <option value="Licenciatura en Mercadeo">Mercadeo</option>
                <option value="Licenciatura en Dise√±o Gr√°fico">Dise√±o Gr√°fico</option>
                <option value="Licenciatura en Ciencias Jur√≠dicas">Ciencias Jur√≠dicas</option>
                <option value="Licenciatura en Psicolog√≠a">Psicolog√≠a</option>
            </select>
            <button onclick="cargarPasantias()" style="background:#6c757d; color:white; border:none; padding:8px; border-radius:4px; cursor:pointer">üîÑ</button>
        </div>
        <div id="pasantiasList">Cargando...</div>
    </div>

    <div id="modalPerfil" class="modal-overlay">
        <div class="modal-content">
            <h3>Editar Datos</h3>
            <label>Nuevo Nombre:</label> <input type="text" id="edit_nombre">
            <label>Nuevo Apellido:</label> <input type="text" id="edit_apellido">
            <label>Nueva Contrase√±a (Opcional):</label> <input type="password" id="edit_pass" placeholder="Dejar vac√≠a para no cambiar">
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button onclick="guardarCambiosPerfil()" style="background:#28a745; color:white; border:none; padding:8px; flex:1; cursor:pointer">Guardar</button>
                <button onclick="document.getElementById('modalPerfil').style.display='none'" style="background:#dc3545; color:white; border:none; padding:8px; flex:1; cursor:pointer">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        let ID_ESTUDIANTE = null;
        let ID_USUARIO = null;
        let MIS_DATOS_GLOBAL = null;

        // Validar sesi√≥n, rol y perfil
        async function iniciar() {
            const sesion = localStorage.getItem('usuario_sigepu');
            if (!sesion) { window.location.href = 'login.html'; return; }
            const usuario = JSON.parse(sesion);
            
            if (usuario.rol !== 'ESTUDIANTE') {
                alert("‚õî Acceso Denegado: Zona de estudiantes.");
                window.location.href = 'login.html'; return;
            }

            ID_USUARIO = usuario.id;
            try {
                const res = await fetch(`/api/estudiantes/usuario/${ID_USUARIO}`);
                if (res.status === 204 || res.status === 404) {
                    document.getElementById('welcomeMsg').innerText = `Hola, ${usuario.email}`;
                    document.getElementById('profileSection').classList.remove('hidden');
                } else if (res.ok) {
                    const estudiante = await res.json();
                    ID_ESTUDIANTE = estudiante.id;
                    document.getElementById('welcomeMsg').innerText = `Hola, ${estudiante.nombre}`;
                    document.getElementById('userCareer').innerText = estudiante.carrera ? estudiante.carrera.nombre : '';
                    document.getElementById('mainSection').classList.remove('hidden');
                    cargarFotoPerfil();
                    cargarPasantias();
                } else throw new Error("Error perfil");
            } catch (e) { alert("Error cr√≠tico: " + e.message); }
        }
        iniciar();

        // Cargar foto
        async function cargarFotoPerfil() {
            try {
                const res = await fetch(`/api/perfil/${ID_USUARIO}/foto`);
                if(res.status === 200) { const data = await res.json(); document.getElementById('imgPerfil').src = data.url; }
            } catch(e) {}
        }

        // Subir foto
        async function subirFoto() {
            const file = document.getElementById('fileInput').files[0];
            if(!file) return;
            const formData = new FormData(); formData.append("file", file);
            try {
                const res = await fetch(`/api/perfil/${ID_USUARIO}/foto`, { method: 'POST', body: formData });
                if(res.ok) { const data = await res.json(); document.getElementById('imgPerfil').src = data.url; }
            } catch(e) {}
        }

        // Modales y formularios
        function abrirEditarPerfil() { document.getElementById('modalPerfil').style.display = 'flex'; }
        
        async function guardarCambiosPerfil() {
            const datos = { nombre: document.getElementById('edit_nombre').value, apellido: document.getElementById('edit_apellido').value, password: document.getElementById('edit_pass').value };
            if(!datos.nombre) delete datos.nombre; if(!datos.apellido) delete datos.apellido;
            try {
                const res = await fetch(`/api/perfil/${ID_USUARIO}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(datos) });
                if(res.ok) { alert("Datos actualizados."); location.reload(); }
            } catch(e) {}
        }

        async function guardarPerfil() {
            const datos = { nombre: document.getElementById('p_nombre').value, apellido: document.getElementById('p_apellido').value, idCarrera: document.getElementById('p_carrera').value };
            try {
                const res = await fetch(`/api/estudiantes/usuario/${ID_USUARIO}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(datos) });
                if(res.ok) { alert("Perfil creado."); location.reload(); }
            } catch(e) {}
        }

        // Cargar y filtrar ofertas
        async function cargarPasantias() {
            const lista = document.getElementById('pasantiasList');
            const filtro = document.getElementById('filtroCarrera').value;
            
            if (!MIS_DATOS_GLOBAL) {
                lista.innerHTML = "‚è≥ Cargando datos...";
                try {
                    const [resPasantias, resMisApps] = await Promise.all([ fetch('/api/pasantias'), fetch(`/api/aplicaciones/estudiante/${ID_ESTUDIANTE}`) ]);
                    const pasantias = await resPasantias.json();
                    const misApps = resMisApps.ok ? await resMisApps.json() : [];
                    MIS_DATOS_GLOBAL = { pasantias, misApps };
                } catch (e) { lista.innerHTML = "Error cargando datos."; return; }
            }

            const { pasantias, misApps } = MIS_DATOS_GLOBAL;
            
            // Verificar si ya fue contratado
            const activa = misApps.find(a => a.estadoUniversidad === 'CONTRATADO');
            const finalizada = misApps.find(a => a.estadoUniversidad === 'FINALIZADO');

            if (activa) {
                lista.innerHTML = `
                    <div style="background:#d4edda; color:#155724; padding:20px; border-radius:8px; border:1px solid #c3e6cb; text-align:center;">
                        <h2>üéâ ¬°Felicidades! Est√°s en una Pasant√≠a Activa</h2>
                        <p>Contratado por: <strong>${activa.pasantia.empresa.nombre}</strong></p>
                        
                        <h3 style="margin-top:20px; color:#28a745">${activa.pasantia.titulo}</h3>
                        <p style="font-style:italic; max-width:600px; margin:0 auto; color:#155724">
                            "${activa.pasantia.descripcion}"
                        </p>
                        <hr style="margin-top:20px; border-top:1px solid #c3e6cb">
                        <small>Tus otras postulaciones han sido canceladas autom√°ticamente.</small>
                    </div>`;
                return;
            }
            if (finalizada) {
                lista.innerHTML = `<div style="background:#cce5ff; color:#004085; padding:20px; border-radius:8px; border:1px solid #b8daff; text-align:center;"><h2>üéì Pasant√≠a Finalizada</h2><p>Completaste tus horas en: <strong>${finalizada.pasantia.empresa.nombre}</strong></p></div>`;
                return;
            }

            const mapaApps = {};
            misApps.forEach(a => { if(a.pasantia) mapaApps[a.pasantia.id] = a; });
            let html = '', contador = 0;

            pasantias.forEach(p => {
                if (filtro !== 'TODAS' && p.carreraRequerida.nombre !== filtro) return;
                contador++;
                const app = mapaApps[p.id];
                let contenidoEstado;

                if (app) {
                    let mensaje = "", estilo = "", mostrarBoton = false;
                    switch (app.estadoUniversidad) {
                        case 'PENDIENTE': mensaje = "üü° En revisi√≥n"; estilo = "st-pendiente"; mostrarBoton = true; break;
                        case 'RECHAZADO': mensaje = "üî¥ Rechazado"; estilo = "st-rechazado"; break;
                        case 'APROBADO': mensaje = "üîµ Aprobado por U."; estilo = "st-aprobado"; mostrarBoton = true; break;
                        case 'SOLICITUD_CANCELACION': mensaje = "üü† Cancelando..."; estilo = "st-pendiente"; break;
                        case 'CANCELADO': mensaje = "‚ö´ Cancelada"; estilo = "st-cancelado"; break;
                        case 'NO_SELECCIONADO': mensaje = "‚ö´ No seleccionado"; estilo = "st-no-seleccionado"; break;
                    }
                    contenidoEstado = `<div class="status-container"><span class="status-label">Estado:</span><div class="${estilo}">${mensaje}</div>${mostrarBoton ? `<button class="btn-cancel-req" onclick="pedirCancelacion(${app.id})">Cancelar Solicitud</button>` : ''}</div>`;
                } else {
                    contenidoEstado = `<button class="btn-apply" onclick="aplicar(${p.id})">üëã Postularme</button>`;
                }
                html += `<div class="card" style="border-left-color: ${app ? '#007bff' : '#28a745'}"><h3>${p.titulo}</h3><p style="color:#555">${p.descripcion}</p><p style="font-size:0.9em">üè¢ <strong>${p.empresa.nombre}</strong> | üéì ${p.carreraRequerida.nombre}</p>${contenidoEstado}</div>`;
            });

            if (contador === 0) html = "<p>No hay ofertas con este filtro.</p>";
            lista.innerHTML = html;
        }

        async function aplicar(idPas) {
            if(!confirm("¬øPostularse?")) return;
            try {
                const res = await fetch('/api/aplicaciones/aplicar', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({idEstudiante: ID_ESTUDIANTE, idPasantia: idPas}) });
                if(res.ok) { alert("¬°Enviado!"); MIS_DATOS_GLOBAL = null; cargarPasantias(); }
                else { const txt = await res.text(); try { alert("Error: " + JSON.parse(txt).message); } catch { alert("Error: " + txt); } }
            } catch (e) { alert("Error de conexi√≥n"); }
        }

        async function pedirCancelacion(idApp) {
            if(confirm("¬øCancelar solicitud?")) {
                await fetch(`/api/aplicaciones/${idApp}/solicitar-cancelacion`, { method: 'PUT' });
                MIS_DATOS_GLOBAL = null; cargarPasantias();
            }
        }

        function logout() { localStorage.removeItem('usuario_sigepu'); window.location.href = 'login.html'; }
    </script>
</body>
</html>